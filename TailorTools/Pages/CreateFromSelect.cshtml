@page
@model ContactModel
@{
}
<h2>Create a "sql CREATE TABLE script from a select query" generator...</h2>

<div class="container">
    <div class="row">
        <div class="col-lg-6">
            <div class="panel panel-default">
                <div class="panel-heading">Put your sql query here:</div>
                <div class="panel-body" id="pasteMeta">
                    <textarea id="txtScript" autofocus onfocus="this.select();" rows="15"
                              onkeyup="if(event.keyCode==13) makeScript();"
                              onchange="makeScript();">Paste your sql "SELECT * FROM..." query here...</textarea>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="panel panel-default">
                <div class="panel-heading">
                    TSql
                    <button class="copy-btn" data-clipboard-target="#classDTO">
                        <img src="images/clipboard.svg" alt="Copy to clipboard">
                    </button>
                </div>
                <div class="panel-body" id="classDTO"></div>
                <div style="font-weight: bold; font-style: italic;">...bring the results from this TSQL, back to Templates.</div>
            </div>
        </div>
    </div>
</div>
@section Scripts
{
    <script>
        document.onload = function init() {
            document.getElementById("txtScript").select();
        }

        function makeScript() {
            var classDTO = document.getElementById('classDTO'),
                txtScript = document.getElementById('txtScript');
            classDTO.innerHTML = script(txtScript.value);
        }

        function script(select) {
            var s = [],
                lf = '<br>';

            s.push("DECLARE @@columns TABLE" + lf);
            s.push("(" + lf);
            s.push("	is_hidden bit," + lf);
            s.push("	column_ordinal int," + lf);
            s.push("    name nvarchar(max)," + lf);
            s.push("    is_nullable bit," + lf);
            s.push("    system_type_id int," + lf);
            s.push("    system_type_name nvarchar(128)," + lf);
            s.push("    max_length int," + lf);
            s.push("	precision int," + lf);
            s.push("	scale int," + lf);
            s.push("	collation_name nvarchar(128)," + lf);
            s.push("	user_type_id int," + lf);
            s.push("	user_type_database nvarchar(128)," + lf);
            s.push("	user_type_schema nvarchar(128)," + lf);
            s.push("	user_type_name nvarchar(128)," + lf);
            s.push("	assembly_qualified_type_name nvarchar(128)," + lf);
            s.push("	xml_collection_id int," + lf);
            s.push("	xml_collection_database nvarchar(128)," + lf);
            s.push("	xml_collection_schema nvarchar(128)," + lf);
            s.push("	xml_collection_name nvarchar(128)," + lf);
            s.push("	is_xml_document bit," + lf);
            s.push("	is_case_sensitive bit," + lf);
            s.push("	is_fixed_length_clr_type bit," + lf);
            s.push("	source_server nvarchar(128)," + lf);
            s.push("	source_database nvarchar(128)," + lf);
            s.push("	source_schema nvarchar(128)," + lf);
            s.push("	source_table nvarchar(128)," + lf);
            s.push("	source_column nvarchar(128)," + lf);
            s.push("	is_identity_column bit," + lf);
            s.push("	is_part_of_unique_key bit," + lf);
            s.push("	is_updateable bit," + lf);
            s.push("	is_computed_column bit," + lf);
            s.push("	is_sparse_column_set bit," + lf);
            s.push("	ordinal_in_order_by_list int," + lf);
            s.push("	order_by_is_descending bit," + lf);
            s.push("	order_by_list_length int," + lf);
            s.push("	tds_type_id int," + lf);
            s.push("	tds_length int," + lf);
            s.push("	tds_collation_id int," + lf);
            s.push("	tds_collation_sort_id int" + lf);
            s.push(")" + lf);
            s.push("declare @@tableName nvarchar(128);" + lf);
            s.push("declare @@select nvarchar(max);" + lf);
            s.push("" + lf);
            s.push("select @@tableName = N'TableName';" + lf);
            s.push("" + lf);
            s.push("select @@select = N'" + select + "';" + lf);
            s.push("" + lf);
            s.push("insert into @@columns" + lf);
            s.push("EXEC sp_describe_first_result_set @@select" + lf);
            s.push("" + lf);
            s.push("SELECT ' create table ' + @@tableName + ' ( ' " + lf);
            s.push("	+ STUFF(( " + lf);
            s.push("		select ', ' + name + ' ' + system_type_name + case when is_nullable = 0 then ' not' else ' ' end + ' null' from @@columns " + lf);
            s.push("		FOR XML PATH ('') ), 1, 1, '' ) " + lf);
            s.push("	+ ')'" + lf);
            s.push("from @@columns group by is_hidden" + lf);

            return s.join('');
        }


    </script>
}